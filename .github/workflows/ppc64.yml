# Copyright 2026, Intel Corporation
# SPDX-License-Identifier: BSD-3-Clause

name: PowerPC64 Tests

permissions: read-all

on:
  pull_request:
    paths:
      - 'src/**'
      - 'builtins/**'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - '.github/workflows/ppc64.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ppc64-test:
    name: PowerPC64LE generic-i32x4 test
    runs-on: ubuntu-22.04
    container:
      image: ubuntu:24.04
      options: --privileged

    steps:
    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y wget gnupg software-properties-common
        # Add LLVM 20 repository
        wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -
        echo "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-20 main" \
          > /etc/apt/sources.list.d/llvm-20.list
        apt-get update
        # Build tools and LLVM
        apt-get install -y git cmake make m4 flex bison python3 libtbb-dev \
          gcc-multilib llvm-20 llvm-20-dev clang-20 libclang-20-dev llvm-20-tools
        # PPC64 cross-compiler and QEMU
        apt-get install -y gcc-powerpc64le-linux-gnu g++-powerpc64le-linux-gnu \
          libc6-dev-ppc64el-cross qemu-user

    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        submodules: true

    - name: Check tools
      run: |
        cmake --version
        /usr/lib/llvm-20/bin/llvm-config --version
        /usr/lib/llvm-20/bin/clang --version
        powerpc64le-linux-gnu-gcc --version
        qemu-ppc64le --version

    - name: Build ISPC with PPC64 support
      run: |
        PATH=/usr/lib/llvm-20/bin:$PATH \
          cmake -B build -DPPC64_ENABLED=ON
        cmake --build build -j"$(nproc)"

    - name: Run lit tests
      run: |
        cmake --build build --target check-all

    - name: Run PPC64LE tests
      run: |
        PATH="$PWD"/build/bin:"$PATH" \
        python3 scripts/run_tests.py \
          --target=generic-i32x4 \
          --arch=ppc64le \
          --wrap-exe="qemu-ppc64le" \
          --compiler=powerpc64le-linux-gnu-g++ \
          -o O2
