# Copyright 2024-2025, Intel Corporation
# SPDX-License-Identifier: BSD-3-Clause

name: Scan release archives with cve-bin-tool

permissions: read-all

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ISPC release version (just number without v, e.g., 1.24.0)'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  release_base_url: https://github.com/ispc/ispc/releases/download/

jobs:
  scan:
    runs-on: ubuntu-latest
    # Disabling this workflow for non ispc/ispc repo as it needs to run on releases only.
    if: github.repository == 'ispc/ispc'

    steps:
    - name: Install cve-bin-tool
      run: |
        pip3 install cve-bin-tool[PDF]

    - name: Download ISPC release archives
      env:
        V: ${{ inputs.version }}
      run: |
        TAR="ispc-examples-v\"$V\".tar.gz ispc-v\"$V\"-linux-oneapi.tar.gz \
             ispc-v\"$V\"-linux.aarch64.tar.gz ispc-v\"$V\"-linux.tar.gz \
             ispc-v\"$V\"-macOS.arm64.tar.gz ispc-v\"$V\"-macOS.universal.tar.gz \
             ispc-v\"$V\"-macOS.x86_64.tar.gz"
        ZIP="ispc-examples-v\"$V\".zip ispc-v\"$V\"-windows.zip"
        for f in "$TAR" "$ZIP"; do
          echo "Download $f"
          wget --quiet -O "$f" ${{ env.release_base_url }}/v"$V"/"$f"
        done

    - name: Scan archvies with cve-bin-tool
      run: |
        cve-bin-tool ./ -f console,pdf,html -o report

    - name: Upload reports
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
      if: always()
      with:
        name: reports
        path: |
          report.txt
          report.pdf
          report.html
