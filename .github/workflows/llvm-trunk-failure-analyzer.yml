# Copyright 2024-2026, Intel Corporation
# SPDX-License-Identifier: BSD-3-Clause

# Analyzes failures in the LLVM trunk nightly workflow using Claude Code.

name: LLVM Trunk Failure Analyzer

on:
  # zizmor: ignore[dangerous-triggers] - workflow_run is intentionally used to analyze nightly failures
  workflow_run:
    workflows: ["Nightly Linux tests / LLVM trunk"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID to analyze (leave empty for latest failed run)'
        required: false
        type: string

permissions: {}

jobs:
  analyze-failure:
    # Disabling this workflow for non ispc/ispc repo, since number of build submissions is limited.
    # Only run if the nightly workflow failed, or if manually triggered
    if: github.repository == 'ispc/ispc' && (github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      issues: write

    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}

    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

    - name: Setup Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        node-version: '20'

    - name: Determine run ID to analyze
      id: get-run-id
      env:
        GH_TOKEN: ${{ github.token }}
        INPUT_RUN_ID: ${{ inputs.run_id }}
        WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
      run: |
        if [ -n "$INPUT_RUN_ID" ]; then
          RUN_ID="$INPUT_RUN_ID"
        elif [ -n "$WORKFLOW_RUN_ID" ]; then
          RUN_ID="$WORKFLOW_RUN_ID"
        else
          # Find the latest failed run of the nightly workflow
          RUN_ID=$(gh run list --workflow="linux-nightly-trunk.yml" --status=failure --limit=1 --json databaseId --jq '.[0].databaseId')
        fi
        echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
        echo "Analyzing run ID: $RUN_ID"

    - name: Download LLVM SHA artifact from failed run
      id: download-sha
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        RUN_ID="${{ steps.get-run-id.outputs.run_id }}"
        echo "Downloading LLVM SHA artifact from run $RUN_ID"

        # Download the artifact
        gh run download "$RUN_ID" --name llvm_commit_sha --dir ./artifacts || {
          echo "Failed to download LLVM SHA artifact"
          echo "current_sha=unknown" >> "$GITHUB_OUTPUT"
          exit 0
        }

        if [ -f "./artifacts/llvm-commit-sha.txt" ]; then
          CURRENT_SHA=$(cat ./artifacts/llvm-commit-sha.txt)
          echo "Current LLVM SHA: $CURRENT_SHA"
          echo "current_sha=$CURRENT_SHA" >> "$GITHUB_OUTPUT"
        else
          echo "LLVM SHA file not found"
          echo "current_sha=unknown" >> "$GITHUB_OUTPUT"
        fi

    - name: Get previous successful run's LLVM SHA
      id: get-previous-sha
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Find the latest successful run before the failed one
        FAILED_RUN_ID="${{ steps.get-run-id.outputs.run_id }}"
        FAILED_RUN_DATE=$(gh run view "$FAILED_RUN_ID" --json createdAt --jq '.createdAt')

        echo "Looking for successful runs before $FAILED_RUN_DATE"

        # Get successful runs and find one before the failed run
        PREV_RUN_ID=$(gh run list --workflow="linux-nightly-trunk.yml" --status=success --limit=5 --json databaseId,createdAt \
          --jq ".[] | select(.createdAt < \"$FAILED_RUN_DATE\") | .databaseId" | head -1)

        if [ -z "$PREV_RUN_ID" ]; then
          echo "No previous successful run found"
          echo "previous_sha=unknown" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "Previous successful run ID: $PREV_RUN_ID"

        # Download artifact from previous run
        gh run download "$PREV_RUN_ID" --name llvm_commit_sha --dir ./prev_artifacts || {
          echo "Failed to download previous LLVM SHA artifact"
          echo "previous_sha=unknown" >> "$GITHUB_OUTPUT"
          exit 0
        }

        if [ -f "./prev_artifacts/llvm-commit-sha.txt" ]; then
          PREV_SHA=$(cat ./prev_artifacts/llvm-commit-sha.txt)
          echo "Previous LLVM SHA: $PREV_SHA"
          echo "previous_sha=$PREV_SHA" >> "$GITHUB_OUTPUT"
        else
          echo "Previous LLVM SHA file not found"
          echo "previous_sha=unknown" >> "$GITHUB_OUTPUT"
        fi

    - name: Get recent ISPC commits
      id: get-ispc-commits
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get ISPC commits from last 24 hours
        SINCE=$(date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%SZ')
        echo "Getting ISPC commits since $SINCE"

        COMMITS=$(git log --since="$SINCE" --oneline HEAD 2>/dev/null || echo "")
        if [ -z "$COMMITS" ]; then
          # Fallback: get last 5 commits
          COMMITS=$(git log --oneline -5 HEAD)
        fi

        echo "Recent ISPC commits:"
        echo "$COMMITS"

        # Save to file for the agent
        echo "$COMMITS" > ispc-recent-commits.txt

    - name: Run Claude Code analyzer
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GH_TOKEN: ${{ github.token }}
      run: |
        RUN_ID="${{ steps.get-run-id.outputs.run_id }}"
        CURRENT_SHA="${{ steps.download-sha.outputs.current_sha }}"
        PREVIOUS_SHA="${{ steps.get-previous-sha.outputs.previous_sha }}"

        echo "=== LLVM Trunk Failure Analysis ==="
        echo "Failed run ID: $RUN_ID"
        echo "Current LLVM SHA: $CURRENT_SHA"
        echo "Previous LLVM SHA: $PREVIOUS_SHA"
        echo "=================================="

        # Run Claude Code with the analyzer skill and capture output
        if ! npx @anthropic-ai/claude-code --print \
          "/analyze-llvm-trunk --run-id $RUN_ID --current-sha $CURRENT_SHA --previous-sha $PREVIOUS_SHA" \
          > analysis_output.txt 2>&1; then
          echo "::error::Claude Code analysis failed"
          echo "=== Analysis Output ==="
          cat analysis_output.txt
          exit 1
        fi
        cat analysis_output.txt

    - name: Create GitHub issue with analysis
      id: create-issue
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        RUN_ID="${{ steps.get-run-id.outputs.run_id }}"
        CURRENT_SHA="${{ steps.download-sha.outputs.current_sha }}"
        RUN_URL="https://github.com/${{ github.repository }}/actions/runs/$RUN_ID"

        # Check if an open issue already exists for LLVM trunk failure
        EXISTING_ISSUE=$(gh issue list --label "llvm-trunk" --state open --limit 1 --json number --jq '.[0].number')

        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Updating existing issue #$EXISTING_ISSUE"
          {
            echo "## New Failure Analysis ($(date -u '+%Y-%m-%d %H:%M UTC'))"
            echo ""
            echo "**Failed run:** $RUN_URL"
            echo "**LLVM SHA:** \`$CURRENT_SHA\`"
            echo ""
            echo "<details>"
            echo "<summary>Analysis Output</summary>"
            echo ""
            cat analysis_output.txt
            echo ""
            echo "</details>"
            echo ""
            echo "---"
            echo "Generated with [Claude Code](https://claude.com/claude-code)"
          } > issue_body.md
          gh issue comment "$EXISTING_ISSUE" --body-file issue_body.md
        else
          echo "Creating new issue"
          {
            echo "## LLVM Trunk Build Failure"
            echo ""
            echo "**Failed run:** $RUN_URL"
            echo "**LLVM SHA:** \`$CURRENT_SHA\`"
            echo ""
            echo "## Analysis"
            echo ""
            cat analysis_output.txt
            echo ""
            echo "---"
            echo "Generated with [Claude Code](https://claude.com/claude-code)"
          } > issue_body.md
          ISSUE_NUMBER=$(gh issue create \
            --title "LLVM trunk nightly build failure" \
            --label "llvm-trunk" \
            --body-file issue_body.md | grep -oE '[0-9]+$')
          echo "Created issue #$ISSUE_NUMBER"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
        else
          echo "issue_number=$EXISTING_ISSUE" >> "$GITHUB_OUTPUT"
        fi

  attempt-fix:
    # Attempt to automatically fix LLVM trunk failures that are fixable on ISPC side
    needs: analyze-failure
    if: success()
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write

    env:
      LLVM_VERSION: "21.1"
      LLVM_TAR: llvm-21.1.8-ubuntu22.04-Release+Asserts-x86.arm.wasm.tar.xz
      LLVM_REPO: https://github.com/ispc/ispc.dependencies

    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        node-version: '20'

    - name: Install build dependencies
      run: |
        echo "APT::Acquire::Retries \"3\";" | sudo tee -a /etc/apt/apt.conf.d/80-retries
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          cmake ninja-build bison flex m4 \
          libc6-dev libc6-dev-i386 g++-multilib \
          libtbb-dev libstdc++6

    - name: Download LLVM
      run: |
        wget -q --retry-connrefused --waitretry=5 --read-timeout=20 --timeout=15 -t 5 \
          "$LLVM_REPO/releases/download/llvm-$LLVM_VERSION-ispc-dev/$LLVM_TAR"
        tar xf "$LLVM_TAR"
        rm -f "$LLVM_TAR"
        echo "$GITHUB_WORKSPACE/bin-$LLVM_VERSION/bin" >> "$GITHUB_PATH"

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Attempt to fix issue
      id: fix-attempt
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GH_TOKEN: ${{ github.token }}
        ISSUE_NUMBER: ${{ needs.analyze-failure.outputs.issue_number }}
      run: |
        if [ -z "$ISSUE_NUMBER" ]; then
          echo "No issue number available, skipping fix attempt"
          exit 0
        fi

        echo "=== Attempting to fix issue #$ISSUE_NUMBER ==="

        # Run Claude Code with the fix-gh-issue command
        if npx @anthropic-ai/claude-code --print \
          "/fix-gh-issue $ISSUE_NUMBER" \
          > fix_output.txt 2>&1; then
          echo "Fix attempt completed"
          cat fix_output.txt
        else
          echo "Fix attempt failed or issue is not fixable on ISPC side"
          cat fix_output.txt
          exit 0
        fi
