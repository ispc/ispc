# Copyright 2024, Intel Corporation
# SPDX-License-Identifier: BSD-3-Clause

name: Scan trunk archives with cve-bin-tool

permissions: read-all

on:
  workflow_dispatch:
  schedule:
    # Run every day at 22:00 UTC
    - cron: '0 22 * * *'

env:
  zip_url: https://ci.appveyor.com/api/projects/ispc/ispc/artifacts/build%2Fispc-trunk-windows.zip?job=Environment%3A%20APPVEYOR_BUILD_WORKER_IMAGE%3DVisual%20Studio%202019%2C%20LLVM_VERSION%3Dlatest
  tar_url: https://ci.appveyor.com/api/projects/ispc/ispc/artifacts/build%2Fispc-trunk-linux.tar.gz?job=Environment%3A%20APPVEYOR_BUILD_WORKER_IMAGE%3DUbuntu2204%2C%20LLVM_VERSION%3Dlatest

jobs:
  scan:
    runs-on: ubuntu-latest
    # Disabling this workflow for non ispc/ispc repo to reduce the traffic to artifacts downloads.
    if: github.repository == 'ispc/ispc'
    permissions:
      security-events: write

    steps:
    - name: Install cve-bin-tool
      run: |
        pip install -r .github/workflows/third-party/requirements.txt

    - name: Download trunk archives
      run: |
        wget --quiet -O archive.zip ${{ env.zip_url }}
        wget --quiet -O archive.tar.gz ${{ env.tar_url }}

    - name: Scan archvies with cve-bin-tool
      run: |
        cve-bin-tool ./ -f console,pdf,html -o report

    - name: Upload reports
      uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b # v4.3.4
      if: always()
      with:
        name: reports
        path: |
          report.txt
          report.pdf
          report.html

